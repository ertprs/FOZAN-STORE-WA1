<!DOCTYPE html>
<html lang="en">
  <title>Whatsapp Web Multi</title>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <script type="module">
    import {
      html, render,
      useState,
      useEffect,
    } from 'https://unpkg.com/htm/preact/standalone.module.js'

    const App = () => {
      const [isLoading, setLoading] = useState(true);
      const [items, setItems] = useState([]);
      const [isConnected, setConnected] = useState(false); 
      const [selectedChat, setSelectedChat] = useState(null);

      useEffect(() => {
        fetch(`/info`)
          .then(res => res.json())
          .then(data => {
            if (data.phone != null) {
              setConnected(true);
              fetch(`/chats`)
                .then(res => res.json())
                .then(data => setItems(data || []))
                .then(() => setLoading(false));
            }
            else
              setLoading(false);
        })
      }, []);

      if (isLoading)
        return html`<${Loading} />`;
      
      if (isConnected)
      {
        if (selectedChat == null) {
          return html`
            <div>
              <div class="list">
                ${items.map(c => html`
                    <div onClick="${() => setSelectedChat(c)}"><${Chat} chat=${c} /></div>
                  `)}
              </div>
            </div>`;
        }
        return html`
          <button onClick="${() => setSelectedChat(null)}">Back</button>
          <${Message} selectedChat="${selectedChat}"/>`;
      }
      return html`<${Disconnect}/>`;
    }

    const Chat = ({chat},{onClick}) =>
        html`
          <div class="repl-list-item">
            <div>
              ${chat.name}
              ${" - "}
              <strong>${chat.unreadCount}</strong>
            </div>
            <p>${chat.msgs}</p>
          </div>
        `;
    
    const Message = ({selectedChat}) => {
      const[isLoading,setIsLoading] = useState(true);
      const[msgs,setMsgs] = useState([]);
      
      useEffect(() => {
        console.log("Message selectedChat: " + selectedChat);
        fetch(`/chat/` + selectedChat.id.user)
          .then(res => res.json())
          .then(data => setMsgs(data || []))
          .then(() => setIsLoading(false));
      }, []);            

      if (isLoading)
        return html`<${Loading} />`;
        
      return html`
          <div class="list">
            <ul>
            ${msgs.map(m => html`
                <strong>${selectedChat.name}</strong>
                <li>${m.body}</li>
              `)}
            </ul>
          </div>
        `;
    }
    
    const Disconnect = () =>
      html`
        <div>Scan QR using Whatsapp on your Phone</div>
        <img src='/qr'/>
      `;

    const Loading = () =>
      html`<div>Loading...</div>`;

    render(html`<${App}/>`, document.body);
  </script>
</html>
