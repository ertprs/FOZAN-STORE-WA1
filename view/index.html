<!DOCTYPE html>
<html lang="en">
  <title>WhatsApp Web Multi</title>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
  </head>
  <script type="module">
    import {
      html, render,
      useState,
      useEffect,
    } from 'https://unpkg.com/htm/preact/standalone.module.js'

    const App = () => {
      const [isLoading, setLoading] = useState(true);
      const [items, setItems] = useState([]);
      const [isConnected, setConnected] = useState(false); 
      const [selectedChat, setSelectedChat] = useState(null);

      useEffect(() => {
        fetch(`/info`)
          .then(res => res.json())
          .then(data => {
            if (data.phone != null) {
              setConnected(true);
              fetch(`/chats`)
                .then(res => res.json())
                .then(data => setItems(data || []))
                .then(() => setLoading(false));
            }
            else
              setLoading(false);
        })
      }, []);

      return html`
          <button onClick="${() => setSelectedChat(null)}">Back</button>
          <${Message} selectedChat="${selectedChat}"/>`;
      
      if (isLoading)
        return html`<${Loading} />`;
      
      if (isConnected)
      {
        if (selectedChat == null) {
          return html`
            <table>
              ${items.map(c => html`
                <tr onClick="${() => setSelectedChat(c)}"><td><${Chat} chat=${c} /></td></tr>
                  `)}
            </table>`;
        }
        return html`
          <button onClick="${() => setSelectedChat(null)}">Back</button>
          <${Message} selectedChat="${selectedChat}"/>`;
      }
      return html`<${Disconnect}/>`;
    }

    const Chat = ({chat}) =>
        html`
        <div>
          <strong>${chat.name}</strong>${chat.unreadCount > 0 && ' - ' + chat.unreadCount}
          <p style='float:right'>${new Date(chat.timestamp * 1000).toLocaleDateString()}</p>
        </div>
        <div>
          <p style='float:left'>${chat.msgs}</p>
        </div>
        `;
    
    const Message = ({selectedChat}) => {
      const[isLoading,setIsLoading] = useState(true);
      const[msgs,setMsgs] = useState([]);
      const[txt,setTxt] = useState("");
      
      useEffect(() => {
        if (selectedChat == null) return;
        fetch(`/chat/` + selectedChat.id.user)
          .then(res => res.json())
          .then(data => setMsgs(data || []))
          .then(() => setIsLoading(false));
      }, []);            

      sendMessage = useCallback(() => console.log(txt));
      
      return html`<input value=${txt} /><button onClick="${() => sendMessage()}">Send</button>`;
      //if (isLoading)
      //  return html`<${Loading} />`;     
      
      return html`
          <table>
            <caption>${selectedChat.name}</caption>
            ${msgs.map(m => html`
              <tr>
                <td align='${m.fromMe ? 'right' : 'left'}' style='background-color: ${m.fromMe ? 'white' : 'lightgrey'}'>${m.body} 
                <sub style='margin-left: 20px'>${new Date(m.timestamp * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: 'false'})}</sub></td>
              </tr>
              `)}
          </table>
          <input value=${txt} /><button onClick=("${() => sendMessage()}")>Send</button>
        `;
    }
    
    const Disconnect = () =>
      html`
        <h3>Scan QR using Whatsapp on your Phone</h3>
        <img src='/qr'/>
      `;

    const Loading = () =>
      html`<div style='position: absolute; top: 50%; width:100%; margin: 0'><center><h1>Loading...</h1></center></div>`;
    
    const Header = () =>
      html`
      <div style='overflow: hidden; position: fixed; top: 0; left:0; width: 100%; background-color: darkseagreen'>
        <center><h2 style='margin-top:1rem'>WhatsApp Web Multi</h2></center>
      </div>`;

    render(html`
      <${Header}/>
      <div style='margin-top:40px'>
        <${App}/>
      </div>`
      , document.body);
  </script>
</html>
